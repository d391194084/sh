<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Windows AD 對話紀錄</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: auto; color: #333; }
        h1, h2, h3 { font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
        h1 { font-size: 2.2em; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        h2 { font-size: 1.8em; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        h3 { font-size: 1.4em; }
        code { font-family: "Consolas", "Monaco", "Courier New", monospace; background-color: #f4f4f4; padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
        pre code { background-color: transparent; padding: 0; font-size: 0.9em; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f9f9f9; font-weight: 600; }
        blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #555; font-style: italic; }
        hr { border: 0; border-top: 1px solid #eee; margin: 2em 0; }
    </style>
</head>
<body>

<h1>Windows AD 對話紀錄</h1>

<h2>第一次詢問：AD 密碼到期循環問題深度分析 (11/4-11/6)</h2>

<p><strong>使用者請求：</strong></p>

<p>【Windows AD 密碼到期循環問題深度分析】背景：伺服器升級後，部分一般使用者權限帳號於登入時反覆彈出密碼到期提示，密碼變更後仍不斷循環且距離到期日尚有數日。請依照下列格式進行分析：1. 診斷流程    - 請根據 11/4-11/6 期間 Windows 事件記錄，分列事件 ID、LogType、錯誤訊息，逐步檢查密碼策略相關紀錄。    - 包含 GPO (群組原則)、FGPP (細緻密碼原則)、複寫延遲、快取資料異常等檢查要點。2. 常見原因    - 分析可能造成密碼到期判定錯誤的技術因素（含政策設定不一致、同步延遲、DFS/快取機制、用戶屬性異常）。3. 修正方式    - 依據診斷結果，提供具體修正步驟，說明 GPO/FGPP 調整建議、事件日誌查詢指令、延遲排查方法，必要時補充 PowerShell 實用指令或常見解決流程。請分段詳列上述三大項目，確保針對 AD 技術細節及 Windows 事件記錄全面解讀。</p>

<hr>

<p><strong>Gemini 回應：</strong></p>

<p>啊，Windows AD 密碼的「土撥鼠之日」迴圈。這問題經典到可以放進 IT 博物館。你以為你換了鎖，但系統堅持要你用舊鑰匙，而且還天天提醒你。</p>

<p>伺服器升級後才出包，這線索很關鍵。十之八九是某個環節的「認知」沒有被同步。</p>

<p>不用驚慌，我們來把這個「政策幽靈」抓出來。</p>

<hr>

<h3>1. 診斷流程：事件日誌的偵探時間</h3>

<p>要找出 11/4 - 11/6 的紀錄，我們得去 Domain Controller (DC) 和出問題的用戶端電腦上翻日誌。重點是「比對」，看誰在說謊。</p>

<p><strong>主要搜查地點：</strong> 網域控制站 (DC) 上的 <code>Security</code> (安全性) 紀錄，以及用戶端電腦上的 <code>System</code> 和 <code>Microsoft-Windows-GroupPolicy/Operational</code> 紀錄。</p>

<p><strong>可疑事件 ID 及分析：</strong></p>

<table>
<thead>
<tr>
<th>事件 ID</th>
<th>LogType (日誌)</th>
<th>錯誤/事件訊息 (範例)</th>
<th>逐步檢查點 (代表什麼)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>4723</strong></td>
<td>Security (DC)</td>
<td>"An attempt was made to change an account's password."</td>
<td><strong>(誰在改密碼)</strong> 這是使用者<strong>自己</strong>改密碼的紀錄。確認 <code>Target Account</code> 是不是出問題的帳號。</td>
</tr>
<tr>
<td><strong>4724</strong></td>
<td>Security (DC)</td>
<td>"An attempt was made to reset an account's password."</td>
<td><strong>(誰被重設密碼)</strong> 這是<strong>管理員</strong>重設密碼。如果這筆紀錄很多，代表 user 一直求救。</td>
</tr>
<tr>
<td><strong>4738</strong></td>
<td>Security (DC)</td>
<td>"A user account was changed."</td>
<td><strong>(密碼屬性檢查)</strong> 這是黃金線索。查看訊息內容的 <code>Password Last Set</code> (密碼上次設定時間) 是否真的更新了。如果這裡更新了，但用戶端還在叫，問題就在用戶端或複寫。</td>
</tr>
<tr>
<td><strong>4625</strong></td>
<td>Security (DC)</td>
<td>"An account failed to log on."</td>
<td><strong>(登入失敗)</strong> 密碼迴圈的受害者。注意 <code>Failure Reason</code>。如果是 <code>0xC000006A</code> (密碼錯誤) 或 <code>0xC0000224</code> (密碼過期)，<code>Status Code</code> 是 <code>0xC000006E</code> (帳號限制)。</td>
</tr>
<tr>
<td><strong>4771</strong></td>
<td>Security (DC)</td>
<td>"Kerberos pre-authentication failed."</td>
<td><strong>(Kerberos 驗證失敗)</strong> 如果 <code>Failure Code</code> 是 <code>0x18</code> (Pre-authentication required) 或 <code>0x17</code> (Password expired)，表示 DC 認為密碼真的到期了。</td>
</tr>
<tr>
<td><strong>4740</strong></td>
<td>Security (DC)</td>
<td>"A user account was locked out."</td>
<td><strong>(鎖定)</strong> 迴圈的副產品。用戶一直試新舊密碼，然後...就沒有然後了。</td>
</tr>
<tr>
<td><strong>8004/8005</strong></td>
<td>Microsoft-Windows-GroupPolicy/Operational (Client)</td>
<td>"Failed to process the Fine-Grained Password Policy..."</td>
<td><strong>(FGPP 錯誤)</strong> 如果用戶端日誌有這個，代表 FGPP 套用失敗或讀取 <code>msDS-ResultantPSO</code> 時出錯。</td>
</tr>
</tbody>
</table>

<p><strong>其他檢查要點：</strong></p>

<ul>
<li><strong>GPO (群組原則):</strong>
    <ul>
    <li>在受影響的用戶端執行 <code>gpresult /h C:\temp\policy.html</code>。</li>
    <li>打開報告，檢查「電腦設定」&gt;「原則」&gt;「Windows 設定」&gt;「安全性設定」&gt;「帳戶原則」&gt;「密碼原則」。</li>
    <li><strong>關鍵：</strong> 看看「勝出的 GPO」是哪一個。是不是你預期的那個？（通常是 Default Domain Policy）。如果 GPO 來自新的伺服器，可能設定不同。</li>
    </ul>
</li>
<li><strong>FGPP (細緻密碼原則):</strong>
    <ul>
    <li>這東西優先權<strong>高於</strong> GPO。如果你的使用者同時被 GPO 和 FGPP 管，FGPP 會贏。</li>
    <li>檢查使用者的 <code>msDS-ResultantPSO</code> 屬性（後面會給指令），看他到底適用哪個原則。</li>
    </ul>
</li>
<li><strong>複寫延遲 (Replication Latency):</strong>
    <ul>
    <li>伺服器升級（尤其是新增或汰換 DC）後最常見的兇手。</li>
    <li>使用者在 DC1 改了密碼，但登入時被導向到 DC2。如果 DC2 還沒收到 DC1 的複寫資料... BINGO！迴圈開始。</li>
    <li>執行 <code>repadmin /showrepl</code> 和 <code>repadmin /replsummary</code> 檢查所有 DC 之間的複寫狀態，看是否有「失敗」或「延遲」 (High delta)。</li>
    </ul>
</li>
<li><strong>快取資料異常 (Cache):</strong>
    <ul>
    <li><strong>用戶端快取：</strong> 用戶端電腦可能快取了舊的 GPO 設定或舊的 Kerberos 票證。</li>
    <li><strong>DFS 快取：</strong> 如果你的 GPO (SYSVOL) 是用 DFS-R 複寫，檢查 DFS 複寫狀態是否健康。</li>
    </ul>
</li>
</ul>

<hr>

<h3>2. 常見原因：為什麼 AD 會「判讀錯誤」？</h3>

<p>AD 通常不笨，他只是「固執」。他會根據他「當下認知」的資訊來判斷。</p>

<ol>
<li><strong>政策設定不一致 (Policy Mismatch):</strong>
    <ul>
    <li><strong>這就是經典的「政策打架」。</strong></li>
    <li><strong>情境：</strong> Default Domain Policy (GPO) 說 90 天到期。但你為「一般使用者」OU 套用了 FGPP (細緻密碼原則)，設了 30 天。</li>
    <li><strong>結果：</strong> 使用者以為自己有 90 天，但系統（FGPP）在第 30 天就開始擋人。使用者改了密碼，但 GPO 的提示（例如 <code>gpresult</code>）可能還在讀 GPO 的設定，造成顯示混亂。</li>
    </ul>
</li>
<li><strong>同步延遲 (Replication Delay):</strong>
    <ul>
    <li><strong>「剛升級伺服器」的最大嫌疑犯。</strong></li>
    <li><strong>情境：</strong> 你有 DC1 (舊) 和 DC2 (新)。使用者連到 DC1 改了密碼，<code>PasswordLastSet</code> 屬性更新。但使用者的登入請求（例如開 Outlook 或連網路磁碟）被導向到 DC2。</li>
    <li><strong>結果：</strong> DC2 的資料庫還是舊的，它認為「密碼錯誤」或「密碼已到期」（如果 <code>PasswordLastSet</code> 太舊）。</li>
    <li><strong>RODC 注意：</strong> 如果你的新伺服器是 Read-Only Domain Controller (RODC)，密碼複寫機制是不同的（需要先快取或轉發驗證），更容易出問題。</li>
    </ul>
</li>
<li><strong>快取機制 (Caching Hell):</strong>
    <ul>
    <li><strong>用戶端快取：</strong> 用戶端電腦會快取登入憑證 (Cached Credentials) 和 Kerberos TGT。如果用戶端在改密碼時「離線」或「網路不穩」，它可能只更新了本機快取，但 DC 沒收到。</li>
    <li><strong>SYSVOL/DFS 快取：</strong> GPO 策略檔是放在 SYSVOL 裡的。如果 SYSVOL (使用 DFSR) 複寫延遲，用戶端 A 套用的是 DC1 的舊 GPO，用戶端 B 套用的是 DC2 的新 GPO。</li>
    </ul>
</li>
<li><strong>使用者屬性異常 (The "Stuck Bit"):</strong>
    <ul>
    <li><strong>最棘手的「幽靈屬性」。</strong></li>
    <li><strong>情境：</strong> 帳號的 <code>userAccountControl</code> 屬性中，有一個 flag 叫 <code>DONT_EXPIRE_PASSWORD</code> (密碼永不到期)。還有一個獨立屬性叫 <code>pwdLastSet</code> (密碼上次設定時間)。</li>
    <li><strong>結果：</strong> 某個管理員或腳本可能在重設密碼時，<strong>勾選了「使用者必須在下次登入時變更密碼」</strong>。使用者變更後，這個 flag 理應<strong>自動清除</strong>。但如果因為權限或複寫問題，這個 flag <strong>卡住了</strong>... 那麼使用者每次登入，都會被要求「變更密碼」。</li>
    </ul>
</li>
</ol>

<hr>

<h3>3. 修正方式：動手解決</h3>

<p>別慌，一個一個來。</p>

<p><strong>A. 立即緩解 (讓使用者先工作)</strong></p>

<ul>
<li>如果你找到那個「卡住」的使用者，直接在 ADUC (Active Directory Users and Computers) 中操作：
    <ol>
    <li>找到該使用者，右鍵「內容」 -&gt; 「帳戶」。</li>
    <li><strong>取消勾選</strong> 「使用者必須在下次登入時變GPO更密碼」。</li>
    <li><strong>(選用，但推薦)</strong> 先勾選「密碼永不到期」，按「套用」。</li>
    <li>再<strong>取消勾選</strong>「密碼永不到期」，按「套用」。</li>
    </ol>
    <ul>
    <li><em>這個「來回切換」的動作可以強制 AD 寫入屬性，清除掉可能卡住的 Paged Search 狀態或 <code>pwdLastSet</code> 的異常值。</em></li>
    </ul>
</li>
</ul>

<p><strong>B. 查詢與分析 (PowerShell 實用指令)</strong></p>

<ul>
<li><p><strong>檢查複寫狀態 (在 DC 上執行):</strong></p>
<pre><code class="language-powershell"># 快速看整體摘要，找 "fails" "errors" "delta" (延遲)
repadmin /replsummary

# 看詳細的複寫夥伴狀態 (替換成你的 DC 名稱)
repadmin /showrepl DC01.yourdomain.com
</code></pre>
    <ul>
    <li><strong>修正：</strong> 如果有失敗，請立即解決（例如防火牆、DNS 或服務問題）。可用 <code>repadmin /syncall /AdeP</code> 強制同步 (小心使用)。</li>
    </ul>
</li>
<li><p><strong>查詢 GPO/FGPP (在 DC 上用 PowerShell):</strong></p>
<pre><code class="language-powershell"># 1. 檢查使用者到底套了哪個密碼原則 (最重要！)
# (替換 &lt;UserName&gt;)
Get-ADUser -Identity &lt;UserName&gt; -Properties "msDS-ResultantPSO"
    
# 如果 'msDS-ResultantPSO' 欄位有值 (例如 "CN=Marketing_FGPP,...")，
# 代表他/她 100% 被 FGPP 管控，Default Domain Policy 對他無效。

# 2. 如果是 FGPP，去看該 FGPP 的設定
Get-ADFineGrainedPasswordPolicy -Identity "Marketing_FGPP" | Format-List *
# 檢查裡面的 MinPasswordAge, MaxPasswordAge, LockoutThreshold...
</code></pre>
    <ul>
    <li><strong>修正：</strong> 如果發現 FGPP 是元兇，要嘛調整 FGPP 的設定，要嘛把使用者移出套用 FGPP 的群組。</li>
    </ul>
</li>
<li><p><strong>檢查使用者的密碼屬性 (在 DC 上用 PowerShell):</strong></p>
<pre><code class="language-powershell"># (替換 &lt;UserName&gt;)
Get-ADUser -Identity &lt;UserName&gt; -Properties PasswordLastSet, PasswordNeverExpires, "msDS-UserPasswordExpiryTimeComputed"

# PasswordLastSet: 密碼上次設定時間 (如果很舊，就是複寫問題)
# PasswordNeverExpires: 是否永不到期
# msDS-UserPasswordExpiryTimeComputed: AD「計算後」認為的到期時間 (這是 AD 的最終判斷)
</code></pre>
    <ul>
    <li><strong>修正：</strong> 如果 <code>PasswordLastSet</code> 明顯是舊的，但使用者發誓他改了，代表複寫延遲。如果 <code>msDS-UserPasswordExpiryTimeComputed</code> 顯示即將到期（或已到期），但 GPO 說不是，請回去查 FGPP。</li>
    </ul>
</li>
<li><p><strong>強制清除用戶端快取 (在出問題的用戶端上):</strong></p>
<pre><code class="language-cmd">:: 1. 清除 DNS 快取 (確保能找到對的 DC)
ipconfig /flushdns

:: 2. 強制 GPO 更新 (拉最新的原則)
gpupdate /force

:: 3. (如果還不行) 清除 Kerberos 票證
klist purge
</code></pre>
    <ul>
    <li><strong>修正：Provider</strong> 如果以上都做了，重開機通常是最後手段，它可以強制清除大部分的本機快取。</li>
    </ul>
</li>
</ul>

<hr>
<hr>

<h2>第二次詢問：AD 密碼到期循環問題 (簡化版 11/3-11/6)</h2>

<p><strong>使用者請求：</strong></p>

<p>Windows AD 伺服器升級後，部分一般使用者出現密碼到期循環提示：
觸發時機：登入時，會判定密碼到期並彈出變更視窗，密碼變更後仍再次提示。
影響：僅一般帳號，密碼實際距離到期日仍有數日。
故障流程：請依 Windows 事件記錄（請分列 ID、LogType、錯誤訊息）分析可能原因，包含 GPO、同步延遲、快取資料等，並給出診斷步驟與建議修正方案。請將分析結果分成「診斷流程」、「常見原因」、「修正方式」。事件集中檢查11/3-11/6的事件</p>

<hr>

<p><strong>Gemini 回應：</strong></p>

<p>這是一個非常典型的 Windows AD 升級後遺症，俗稱「密碼到期土撥鼠之日」。使用者（和 IT）被困在一個永無止盡的變更密碼迴圈中。</p>

<p>伺服器升級是關鍵線索，這強烈指向「複寫延遲」或「政策不一致」。由於只有一般使用者出問題，也可能與特定 OU 套用的 GPO 或 FGPP 有關。</p>

<p>以下是針對此問題的深度分析，我們將嚴格檢查 11/3 至 11/6 的事件紀錄來找出元兇。</p>

<hr>

<h3>1. 診斷流程：事件日誌的偵探時間</h3>

<p>要找出真相，我們必須同時檢查<strong>網域控制站 (DC)</strong>（尤其是新舊伺服器）上的 <code>Security</code> (安全性) 日誌，以及<strong>受影響的用戶端電腦</strong>上的 <code>System</code> 和 <code>GroupPolicy</code> 日誌。</p>

<p><strong>11/3 - 11/6 關鍵事件 ID 檢查表：</strong></p>

<table>
<thead>
<tr>
<th>事件 ID</th>
<th>LogType (日誌)</th>
<th>錯誤/事件訊息 (範例)</th>
<th>逐步檢查點 (代表什麼)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>4738</strong></td>
<td>Security (DC)</td>
<td>"A user account was changed."<br>(使用者帳戶已變更)</td>
<td><strong>(黃金線索)</strong> 這是追蹤的核心。當迴圈發生時，檢查此事件中的 <code>Password Last Set</code> (密碼上次設定時間) 欄位。<br><strong>檢查：</strong> 該欄位時間是否<strong>真的</strong>更新了？如果更新了，但使用者下次登入仍被提示，問題就出在「複寫」或「屬性卡住」。</td>
</tr>
<tr>
<td><strong>4723</strong></td>
<td>Security (DC)</td>
<td>"An attempt was made to change an account's password."<br>(嘗試變更帳戶密碼)</td>
<td><strong>(使用者行為)</strong> 這是使用者<strong>自己</strong>成功變更密碼的紀錄。這應該會在 4738 之前或同時發生。</td>
</tr>
<tr>
<td><strong>4625</strong></td>
<td>Security (DC)</td>
<td>"An account failed to log on."<br>(帳戶登入失敗)</td>
<td><strong>(失敗軌跡)</strong> 這是迴圈的受害者。重點看 <code>Failure Reason</code> (失敗原因)。<br><em> <code>Status</code> 為 <code>0xC000006E</code> 或 <code>Failure Information</code> 為 <code>User logon restricted</code> (使用者登入受限)。<br></em> <code>Sub Status</code> (子狀態) 為 <code>0xC0000224</code> (密碼必須變更) 或 <code>0xC000006A</code> (密碼錯誤)。</td>
</tr>
<tr>
<td><strong>4771</strong></td>
<td>Security (DC)</td>
<td>"Kerberos pre-authentication failed."<br>(Kerberos 預先驗證失敗)</td>
<td><strong>(驗證核心)</strong> 這是 DC 拒絕登入的直接原因。檢查 <code>Failure Code</code> (失敗代碼)：<br><em> <code>0x17</code> (KDC_ERR_PWD_EXPIRED): DC 判定密碼「已到期」。<br></em> <code>0x18</code> (KDC_ERR_PREAUTH_FAILED): 密碼錯誤（可能是新舊密碼在不同 DC 上的認知混亂）。</td>
</tr>
<tr>
<td><strong>4740</strong></td>
<td>Security (DC)</td>
<td>"A user account was locked out."<br>(使用者帳戶已鎖定)</td>
<td><strong>(副作用)</strong> 如果迴圈一直轉，使用者可能會不小心觸發鎖定策略。如果 11/3-11/6 期間這類事件暴增，就是警訊。</td>
</tr>
<tr>
<td><strong>8004</strong></td>
<td>Microsoft-Windows-GroupPolicy/Operational (Client)</td>
<td>"Failed to process the Fine-Grained Password Policy."<br>(處理 FGPP 失敗)</td>
<td><strong>(用戶端日誌)</strong> 如果在用戶端電腦上看到這個，代表用戶端無法正確讀取或套用 FGPP，這可能導致它依賴舊的(或錯誤的)快取策略。</td>
</tr>
</tbody>
</table>

<p><strong>其他檢查要點：</strong></p>

<ol>
<li><strong>GPO (群組原則):</strong>
    <ul>
    <li>在受影響的用戶端執行 <code>gpresult /h C:\temp\policy.html</code>。</li>
    <li><strong>檢查：</strong> 打開報告，查看「帳戶原則/密碼原則」下的「勝出的 GPO」(Winning GPO)。是不是你預期的 GPO（例如 Default Domain Policy）？還是某個新伺服器帶來的奇怪 GPO？</li>
    </ul>
</li>
<li><strong>FGPP (細緻密碼原則):</strong>
    <ul>
    <li>FGPP 優先權<strong>高於</strong> GPO。如果一般使用者 OU 被套用了 FGPP，它會覆蓋 GPO 設定。</li>
    <li><strong>檢查：</strong> 檢查使用者的 <code>msDS-ResultantPSO</code> 屬性（見下方 PowerShell 指令），確認他們是否意外地被 FGPP 鎖定（可能 FGPP 的密碼到期日比 GPO 短）。</li>
    </ul>
</li>
<li><strong>複寫延遲 (Replication Latency):</strong>
    <ul>
    <li><strong>最大嫌疑犯。</strong> 伺服器升級（尤其是新增或更換 DC）後，站台 (Site) 設定或複寫排程可能尚未最佳化。</li>
    <li><strong>檢查：</strong> 在 DC 上執行 <code>repadmin /showrepl</code> 和 <code>repadmin /replsummary</code>。注意看「失敗」(fails)、「錯誤」(errors) 或「deltatime」(延遲時間) 是否過高。</li>
    </ul>
</li>
<li><strong>快取資料異常 (Cache):</strong>
    <ul>
    <li><strong>用戶端快取：</strong> 用戶端電腦會快取 Kerberos 票證 (TGT)。如果它拿著舊票證去存取資源，就會被拒絕。</li>
    <li><strong>DFS/SYSVOL 快取：</strong> GPO 策略檔儲存在 SYSVOL 中，通常由 DFSR 複寫。如果 DFSR 延遲，用戶端可能讀到舊的 GPO 範本，導致顯示錯誤的「到期日」。</li>
    </ul>
</li>
</ol>

<hr>

<h3>2. 常見原因：為何 AD 會「誤判」？</h3>

<p>「距離到期日尚有數日」卻被提示，這代表 AD 的某個部分拿到了錯誤的資訊。</p>

<ol>
<li><strong>複寫延遲 (Replication Delay) - 最可能</strong>
    <ul>
    <li><strong>情境：</strong> 你的環境有多台 DC（例如舊的 DC1 和新的 DC2）。</li>
    <li>使用者登入時，由 DC1 驗證，DC1 說：「你的密碼快到了，該改了」（或卡住了，要求必須改）。</li>
    <li>使用者在 DC1 上<strong>成功變更了密碼</strong>（<code>PasswordLastSet</code> 屬性更新）。</li>
    <li>使用者<strong>再次登入</strong>時，負載平衡將他導向了<strong>新的 DC2</strong>。</li>
    <li><strong>核心問題：</strong> DC1 的密碼變更尚未複寫到 DC2。DC2 拿著舊資料，判定「密碼錯誤」或「你根本沒改，必須改」，於是再次彈出變更視窗。</li>
    </ul>
</li>
<li><strong>使用者屬性異常 (Stuck Flag)</strong>
    <ul>
    <li><strong>情境：</strong> 在使用者的 AD 帳戶屬性中，有一個 flag 叫 <code>pwdLastSet</code> (密碼上次設定時間)。</li>
    <li>如果這個值被設為 <code>0</code>，AD 會強制使用者在「下次登入時變更密碼」。</li>
    <li><strong>核心問題：</strong> 使用者變更後，這個 flag 應自動更新為當前時間。但如果因為權限、複寫或 Bug，這個 flag <strong>卡住了</strong>（沒有被更新，或又被改回 <code>0</code>），使用者就會陷入「每次登入都必須變更」的迴圈。</li>
    </ul>
</li>
<li><strong>政策設定不一致 (GPO vs. FGPP)</strong>
    <ul>
    <li><strong>情境：</strong> 伺服器升級後，可能動到了 GPO 連結或 OU 結構。</li>
    <li><strong>核心問題：</strong> 你的 Default Domain Policy (GPO) 說密碼 90 天到期。但「一般使用者」OU <strong>同時</strong>被套用了一個 FGPP（細緻密碼原則），而該原則設為 45 天。</li>
    <li>使用者以為還有 45 天（根據 GPO），但 FGPP（優先權更高）早已判定到期，不斷強制他變更。</li>
    </ul>
</li>
<li><strong>用戶端快取 (Client-Side Cache)</strong>
    <ul>
    <li><strong>情境：</strong> 用戶端電腦（尤其是筆電）可能快取了舊的 GPO 設定或登入憑證。</li>
    <li><strong>核心問題：</strong> 即使 DC 上的問題解決了，用戶端仍拿著舊的 Kerberos 票證或錯誤的 GPO 快取去驗證，導致判斷錯誤。</li>
    </ul>
</li>
</ol>

<hr>

<h3>3. 修正方式：具體步驟與指令</h3>

<p>請依照「立即緩解」、「根本診斷」、「清除障礙」的順序操作。</p>

<p><strong>A. 立即緩解 (讓使用者先工作)</strong></p>

<p>如果使用者卡在登入畫面，請 IT 管理員立即在 DC 上操作：</p>

<ol>
<li>開啟「Active Directory 使用者和電腦 (ADUC)」。</li>
<li>找到該使用者，右鍵「內容」 -&gt; 「帳戶」頁籤。</li>
<li><strong>取消勾選</strong> 「使用者必須在下次登入時變更密碼」。</li>
<li><strong>(關鍵步驟)</strong> 先<strong>勾選</strong>「密碼永不到期」，按「套用」。</li>
<li>再<strong>取消勾選</strong>「密碼永不到期」，按「套用」。
    <ul>
    <li><em>這個「來回切換」的動作可以強制 AD 寫入屬性，清除掉可能卡住的 <code>pwdLastSet=0</code> 狀態。</em></li>
    </ul>
</li>
</ol>

<p><strong>B. 根本診斷 (PowerShell 實用指令)</strong></p>

<p>(在 DC 上以系統管理員身分執行 PowerShell)</p>

<pre><code class="language-powershell"># 1. 檢查複寫狀態 (查看 11/3-11/6 是否有高延遲)
repadmin /replsummary
# 尋找 "fails" (失敗) 或 "largest delta" (最大延遲) 過長的 DC。

# 2. 檢查使用者的密碼屬性 (替換 &lt;UserName&gt;)
Get-ADUser -Identity &lt;UserName&gt; -Properties PasswordLastSet, PasswordNeverExpires, "msDS-UserPasswordExpiryTimeComputed"
# PasswordLastSet: 密碼上次設定時間 (如果很舊，就是複寫問題)
# msDS-UserPasswordExpiryTimeComputed: AD「計算後」認為的到期時間 (這是 AD 的最終判斷)

# 3. 檢查使用者是否被 FGPP 管控 (替換 &lt;UserName&gt;)
Get-ADUser -Identity &lt;UserName&gt; -Properties "msDS-ResultantPSO"
# 如果 'msDS-ResultantPSO' 欄位有值 (例如 "CN=Sales_FGPP,...")，
# 代表他 100% 被 FGPP 管控，請立刻去檢查該 FGPP 的設定。

# 4. 取得該 FGPP 的詳細設定 (如果上一步有找到)
Get-ADFineGrainedPasswordPolicy -Identity "Sales_FGPP" | Format-List *
# 檢查 MaxPasswordAge (最大密碼存留期) 是否比 GPO 短。
</code></pre>

<p><strong>C. 修正與清除</strong></p>

<ol>
<li><strong>(若為複寫問題)</strong>
    <ul>
    <li><code>repadmin /showrepl</code>：檢查詳細錯誤，通常是 DNS、防火牆或站台連結問題。</li>
    <li><code>repadmin /syncall /AdeP</code>：(謹慎使用) 強制在所有 DC 間同步所有分割區。</li>
    </ul>
</li>
<li><strong>(若為 GPO/FGPP 問題)</strong>
    <ul>
    <li>調整 GPO 或 FGPP 的 <code>Maximum password age</code> (最大密碼存留期) 設定，使其一致。</li>
    <li>如果不想使用 FGPP，請將使用者從套用 FGPP 的群組中移除。</li>
    </ul>
</li>
<li><strong>(若為用戶端快取問題)</strong>
    <ul>
    <li>在受影響的用戶端電腦上，以系統管理員身分執行：
    <pre><code class="language-cmd">:: 1. 清除 Kerberos 票證
klist purge
    
:: 2. 強制 GPO 更新 (拉最新的原則)
gpupdate /force
    
:: 3. (如果還不行) 清除 DNS 快取並重設網路
ipconfig /flushdns
netsh int ip reset
</code></pre>
    </li>
    <li>最後，<strong>重開機</strong>。重開機是清除用戶端快取最有效的方法。</li>
    </ul>
</li>
</ol>

<hr>
<hr>

<h2>第三次詢問：在 AD1/AD2 故障時安裝 AD3 (Server 2025)</h2>

<p><strong>使用者請求：</strong></p>

<p>在現有AD1和AD2都出現問題的情境下，如何安裝並設置一台Windows Server 2025為新的域控制器AD3，並安全地將Active Directory服務移轉到AD3？請涵蓋包括前置環境檢查、資料備份、AD複寫檢查、安裝和域控角色轉移，以及最終舊域控降級的完整步驟和最佳實務。</p>

<hr>

<p><strong>Gemini 回應：</strong></p>

<p>啊，「都出現問題」。這在 IT 術語裡，通常是「一切都著火了」的委婉說法。</p>

<p>在一個不健康的 AD 環境中加入新的 DC，就像試圖把一根乾淨的湯匙放進一鍋...嗯，有問題的湯裡。你不會得到一鍋好湯，你只會得到一根髒湯匙。</p>

<p><strong>最高指導原則：</strong> 除非絕對必要（例如 AD1 和 AD2 已經完全陣亡），否則<strong>切勿在一個不健康的環境中新增 DC</strong>。垃圾進，垃圾出。如果你強行將 AD3 加入一個複寫（Replication）已經損壞的網域，AD3 也會立刻被汙染。</p>

<p>所以，我們的計畫不是「直接移轉」，而是「救援、穩定、再移轉」。</p>

<p>以下是完整的救援與移轉作戰手冊。</p>

<hr>

<h3>🚨 階段 0：停止並診斷 (評估火勢)</h3>

<p>在你做任何安裝之前，你必須先當偵探。<strong>如果 AD1 和 AD2 的問題是可修復的，你必須先修復它們。</strong></p>

<ol>
<li><p><strong>健康檢查 (DCDIAG)：</strong>
在 AD1 和 AD2 上（如果它們還活著）執行：</p>
<pre><code class="language-cmd">DCDIAG /v /c /e /q
</code></pre>
    <ul>
    <li><code>/v</code> (Verbose) 會給你所有細節。</li>
    <li><code>/q</code> (Quiet) 只顯示錯誤。</li>
    <li><strong>檢查什麼：</strong> 注意 <code>Failed</code> (失敗) 的測試，尤其是 <code>Replications</code>、<code>NCSecDesc</code>、<code>Services</code>、<code>FSMO</code>。如果這裡滿江紅，你的 AD 已經在加護病房了。</li>
    </ul>
</li>
<li><p><strong>複寫檢查 (REPADMIN)：</strong>
這是檢查 DC 之間是否還在「對話」的黃金標準。</p>
<pre><code class="language-cmd">repadmin /replsummary
</code></pre>
    <ul>
    <li><strong>檢查什麼：</strong> <code>Fails</code> (失敗) 欄位必須是 <code>0</code>。如果不是，查看 <code>Largest Delta</code> (最大延遲) 欄位，看它們多久沒溝通了。如果超過了「Tombstone 存留期」（預設 60 或 180 天），那它們可能已經永遠分手了。</li>
    </ul>
<pre><code class="language-cmd">repadmin /showrepl
</code></pre>
    <ul>
    <li><strong>檢查什麼：</strong> 顯示詳細的複寫夥伴關係。任何錯誤訊息（如 "RPC server is unavailable" 或 "access denied"）都是你需要解決的。</li>
    </ul>
</li>
</ol>

<p><strong>殘酷的現實：</strong>
如果 <code>DCDIAG</code> 和 <code>REPADMIN</code> 顯示複寫已經完全中斷且無法修復（例如 USN Rollback、Tombstone 問題），你不能「移轉」。你可能需要進行「強制降級」和「中繼資料清理」，這是一個更危險的過程。</p>

<p><strong>但我們先假設問題是可控的，或者 AD1/AD2 至少有一台還能撐著。</strong></p>

<hr>

<h3>階段 1：前置準備 (打掃戰場)</h3>

<p>假設你已經穩住了 AD1/AD2 的基本運作，或者至少有一台是 FSMO 角色的持有者且能運作。</p>

<ol>
<li><strong>完整備份 (System State)：</strong>
    <ul>
    <li><strong>動作：</strong> 在 AD1 和 AD2 上，使用 Windows Server Backup 或你的企業備份軟體，執行 <strong>系統狀態 (System State)</strong> 備份。</li>
    <li><strong>理由：</strong> 如果接下來的任何步驟（尤其是 Schema 升級）炸了，這是你唯一的退路。</li>
    </ul>
</li>
<li><strong>功能等級 (Functional Level) 檢查：</strong>
    <ul>
    <li><strong>動作：</strong> 確保你的「樹系功能等級 (FFL)」和「網域功能等級 (DFL)」至少是 <strong>Windows Server 2012 R2</strong>（或至少 2008 R2，但 2012 R2+ 更理想）。Server 2025 不喜歡太舊的環境。</li>
    <li><strong>指令 (PowerShell)：</strong>
        <pre><code class="language-powershell">Get-ADForest | fl ForestFunctionality
Get-ADDomain | fl DomainFunctionality
</code></pre>
    </li>
    <li><strong>理由：</strong> 太舊的等級會阻止 2025 DC 的加入。</li>
    </ul>
</li>
<li><strong>SYSVOL 複寫檢查 (FRS vs. DFSR)：</strong>
    <ul>
    <li><strong>這是天大的陷阱！</strong> Windows Server 2008 R2 之後的 DC 不再支援舊的 FRS (檔案複寫服務) 來複寫 SYSVOL。</li>
    <li><strong>動作：</strong> 檢查你是否還在使用 FRS。如果 AD1/AD2 是從 Server 2003/2008 時代一路升上來的，你很可能還在用。</li>
    <li><strong>檢查方法：</strong> <code>dfsmig /getmigrationstate</code>。如果顯示 <code>Eliminated</code> (已消除)，恭喜你是 DFSR。如果不是，你<strong>必須</strong>先完成 [FRS 到 DFSR 的移轉](https://learn.microsoft.com/zh-tw/windows-server/storage/dfs-replication/migrate-sysvol-to-dfsr?tabs=Srv1%2Cpowershell)。</li>
    <li><strong>理由：</strong> Server 2025 <strong>絕對不會</strong>與使用 FRS 的 DC 複寫 SYSVOL，你的 GPO 會全毀。</li>
    </ul>
</li>
<li><strong>Schema 準備 (Adprep)：</strong>
    <ul>
    <li><strong>動作：</strong> 在安裝 2025 之前，你需要擴充 AD Schema。在過去，這是在 2025 安裝光碟的 <code>\support\adprep</code> 資料夾中找到 <code>adprep.exe</code> 並在 Schema Master (AD1 或 AD2) 上執行。</li>
    <li><strong>現代作法：</strong> 從 Server 2012 開始，<code>adprep</code> 已經整合到 DC 的升級精靈中。但為了安全起見，最佳實務是<strong>手動</strong>在 FSMO 角色持有者上執行。</li>
    <li><strong>在持有 Schema Master 角色的 DC 上 (假設是 AD1)：</strong>
        <pre><code class="language-cmd">[掛載 2025 ISO]
D:\support\adprep\adprep.exe /forestprep
D:\support\adprep\adprep.exe /domainprep
</code></pre>
    </li>
    <li><strong>理由：</strong> 這會更新 AD Schema，加入 2025 需要的新物件和屬性。</li>
    </ul>
</li>
</ol>

<hr>

<h3>階段 2：安裝 AD3 (引入新血)</h3>

<ol>
<li><strong>安裝 Windows Server 2025：</strong>
    <ul>
    <li>安裝標準版或資料中心版 (含桌面體驗)。</li>
    <li>設定靜態 IP。</li>
    <li><strong>重要：</strong> 在 DNS 設定中，將「主要 DNS」指向<strong>目前還活著的 DC (AD1 或 AD2)</strong>，次要 DNS 設為 <code>127.0.0.1</code> (它自己)。</li>
    <li>將這台伺服器命名為 AD3，並將其<strong>加入現有網域</strong> (yourdomain.com)，暫時作為一台「成員伺服器」。</li>
    </ul>
</li>
<li><strong>安裝 AD DS 角色：</strong>
    <ul>
    <li>在 AD3 的「伺服器管理員」中，新增「Active Directory Domain Services」角色。</li>
    <li>這會一併安裝所需的 DNS、GPO 管理等工具。</li>
    </ul>
</li>
<li><strong>升級為網域控制站：</strong>
    <ul>
    <li>安裝完角色後，「伺服器管理員」右上角會出現一個黃色驚嘆號。</li>
    <li>點選「將此伺服器升級為網域控制站」。</li>
    <li>選擇「將網域控制站新增至現有網域」。</li>
    <li><strong>關鍵選項：</strong>
        <ul>
        <li>確保勾選 <strong>DNS 伺服器</strong>。</li>
        <li>確保勾選 <strong>Global Catalog (GC)</strong> (通用類別目錄)。</li>
        <li>(如果這是你的第一個 Server 2025，RODC 選項會是灰色的，很好。)</li>
        <li>輸入 DSRM (目錄服務還原模式) 密碼。<strong>請把這組密碼記在安全的地方，你未來會感謝你自己。</strong></li>
        </ul>
    </li>
    </ul>
</li>
</ol>

<hr>

<h3>階段 3：複寫與驗證 (耐心等待)</h3>

<p>AD3 升級並重啟後，<strong>不要急著做任何事</strong>。</p>

<ol>
<li><strong>去喝杯咖啡。</strong> 真的。AD 需要時間複寫。</li>
<li><strong>檢查複寫：</strong>
    <ul>
    <li>在 AD3 上執行 <code>repadmin /replsummary</code> 和 <code>repadmin /showrepl</code>。</li>
    <li>確保它能成功地與 AD1 和 AD2 (或至少是還活著的那一台) 進行「傳入」和「傳出」的複寫。</li>
    </ul>
</li>
<li><strong>檢查健康：</strong>
    <ul>
    <li>在 AD3 上執行 <code>dcdiag /v /c /e /q</code>。</li>
    <li>在初始複寫完成後，它應該要通過所有測試。</li>
    </ul>
</li>
<li><strong>檢查 SYSVOL：</strong>
    <ul>
    <li>去 <code>C:\Windows\SYSVOL\domain\Policies</code> 目錄，看看 GPO 是不是都同步過來了。如果這裡是空的，代表你的 FRS/DFSR 移轉沒做好，或者複寫有問題。</li>
    </ul>
</li>
</ol>

<hr>

<h3>階段 4：轉移 FSMO 角色 (權力交接)</h3>

<p>在確認 AD3 100% 健康且複寫正常後，我們可以開始轉移 5 個 FSMO 角色。<strong>「轉移」(Transfer)</strong> 是和平的；<strong>「奪取」(Seize)</strong> 是暴力的 (只在原持有者死亡時使用)。</p>

<p><strong>最佳實務：</strong> 使用 PowerShell 在 AD3 上執行。</p>

<pre><code class="language-powershell"># 1. 檢查目前誰持有 FSMO 角色
Get-ADDomain | Select-Object PDCEmulator, RIDMaster, InfrastructureMaster
Get-ADForest | Select-Object SchemaMaster, DomainNamingMaster

# 2. 在 AD3 上執行以下指令，一次性和平轉移
Move-ADDirectoryServerOperationMasterRole -Identity "AD3" -OperationMasterRole 0,1,2,3,4
# 0 = PDCEmulator
# 1 = RIDMaster
# 2 = InfrastructureMaster
# 3 = SchemaMaster
# 4 = DomainNamingMaster

# (如果 AD1/AD2 已經死了，你需要「強制奪取」)
# Move-ADDirectoryServerOperationMasterRole -Identity "AD3" -OperationMasterRole 0,1,2,3,4 -Force
# (警告：奪取後，舊的 DC 永遠不能再上線)
</code></pre>

<p><strong>驗證：</strong> 再次執行步驟 1 的檢查指令，確保 5 個角色都顯示在 AD3 上。</p>

<hr>

<h3>階段 5：最終清理與降級 (告別舊時代)</h3>

<p>在 AD3 成為 FSMO 角色持有者並穩定運行<strong>數日</strong> (不是數小時) 之後：</p>

<ol>
<li><strong>更新 DNS：</strong>
    <ul>
    <li><strong>DHCP：</strong> 更新你的 DHCP 範圍 (Scope) 選項，將 DNS 伺服器設定改為 AD3 (主要) 和 AD1/AD2 (次要，或直接刪除)。</li>
    <li><strong>靜態 IP 裝置：</strong> 確保所有伺服器、印表機等，都改用 AD3 作為主要 DNS。</li>
    </ul>
</li>
<li><strong>轉移其他服務：</strong>
    <ul>
    <li>檢查 AD1/AD2 上是否還有其他服務 (例如 CA 憑證服務、RADIUS/NPS、DHCP 等)？如果有的話，需要單獨移轉這些服務。</li>
    </ul>
</li>
<li><strong>安全降級 (Demote)：</strong>
    <ul>
    <li>當你 100% 確定 AD3 已接管一切，且 AD1/AD2 不再重要時，你可以在 AD1 和 AD2 上執行降級。</li>
    <li><strong>動作：</strong> 在 AD1 (和 AD2) 上，進入「伺服器管理員」，選擇「管理」-&gt;「移除角色及功能」。</li>
    <li>取消勾選「Active Directory Domain Services」。</li>
    <li>精靈會引導你「將此網域控制站降級」。</li>
    <li><strong>重要：</strong> C:\Users\jchsu\OneDrive\文件 確保 <strong>不要</strong> 勾選「這是此網域中的最後一個網域控制站」。</li>
    </ul>
</li>
<li><strong>最終清理 (Metadata Cleanup)：</strong>
    <ul>
    <li>降級理應會自動清理中繼資料。但如果降級失敗（因為它們本來就有問題），你可能需要手動清理。</li>
    <li><strong>動作：</strong> 在 AD3 上，檢查「Active Directory 使用者和電腦」中的 <code>Domain Controllers</code> OU，確保 AD1 和 AD2 已消失。</li>
    <li>檢查「Active Directory 站台和服務」，移除 AD1 和 AD2 的伺服器物件。</li>
    <li>檢查 DNS，刪除 AD1 和 AD2 殘留的 A 記錄和 SRV 記錄。</li>
    </ul>
</li>
<li><strong>提升功能等級：</strong>
    <ul>
    <li>當你的環境中只剩下 2025 DC (或至少都是 2012 R2 以上) 時，別忘了提升你的 FFL 和 DFL，享受新功能。</li>
    </ul>
</li>
</ol>

<p>這是一場網路的心臟繞道手術，不是簡單的升級。請務必在「階段 0」花足夠的時間，祝你好運。</p>

</body>
</html>S